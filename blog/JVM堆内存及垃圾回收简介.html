<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-mac-osx.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"www.sakuratears.top",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!0,color:"#222",save:"manual"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="前言我们知道在JVM内存模型中，堆是十分重要的一块，堆是内存占用最大，管理最复杂的一个区域，其用途就是存放生成的对象实例，所有的对象都会在堆上进行分配使用。 JDK1.8后，字符串常量池从永久代剥离了出来，也存放在了堆上。 正文"><meta property="og:type" content="article"><meta property="og:title" content="JVM堆内存及垃圾回收简介"><meta property="og:url" content="https://www.sakuratears.top/blog/JVM%E5%A0%86%E5%86%85%E5%AD%98%E5%8F%8A%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%80%E4%BB%8B.html"><meta property="og:site_name" content="SakuraTears的博客"><meta property="og:description" content="前言我们知道在JVM内存模型中，堆是十分重要的一块，堆是内存占用最大，管理最复杂的一个区域，其用途就是存放生成的对象实例，所有的对象都会在堆上进行分配使用。 JDK1.8后，字符串常量池从永久代剥离了出来，也存放在了堆上。 正文"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-420.png"><meta property="og:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-421.png"><meta property="og:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-422.png"><meta property="og:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-423.png"><meta property="og:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-424.png"><meta property="og:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-425.png"><meta property="og:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-426.png"><meta property="og:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-427.png"><meta property="og:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-428.png"><meta property="og:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-428.gif"><meta property="article:published_time" content="2019-06-27T13:48:00.000Z"><meta property="article:modified_time" content="2019-06-27T14:10:50.000Z"><meta property="article:author" content="SakuraTears"><meta property="article:tag" content="Java"><meta property="article:tag" content="JVM"><meta property="article:tag" content="GC"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-420.png"><link rel="canonical" href="https://www.sakuratears.top/blog/JVM%E5%A0%86%E5%86%85%E5%AD%98%E5%8F%8A%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%80%E4%BB%8B.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>#needsharebutton-float{bottom:88px;cursor:pointer;left:-8px;position:fixed;z-index:9999}#needsharebutton-float .btn{border:1px solid $btn-default-border-color;border-radius:4px;padding:0 10px 0 14px}</style><title>JVM堆内存及垃圾回收简介 | SakuraTears的博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="SakuraTears的博客" type="application/atom+xml"><link rel="stylesheet" href="/assets/css/APlayer.min.css" class="aplayer-style-marker">
<script src="/assets/js/APlayer.min.js" class="aplayer-script-marker"></script>
</head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">SakuraTears的博客</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">越努力越幸运</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-support"><a href="/support/" rel="section"><i class="fa fa-bookmark fa-fw"></i>支持</a></li><li class="menu-item menu-item-photos"><a href="/photos/" rel="section"><i class="fa fa-camera fa-fw"></i>相册</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/javazwt" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.sakuratears.top/blog/JVM%E5%A0%86%E5%86%85%E5%AD%98%E5%8F%8A%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%80%E4%BB%8B.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/others/avatar.jpg"><meta itemprop="name" content="SakuraTears"><meta itemprop="description" content="越努力越幸运"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="SakuraTears的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">JVM堆内存及垃圾回收简介</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-06-27 21:48:00 / 修改时间：22:10:50" itemprop="dateCreated datePublished" datetime="2019-06-27T21:48:00+08:00">2019-06-27</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">学习</span></a> </span></span><span id="/blog/JVM%E5%A0%86%E5%86%85%E5%AD%98%E5%8F%8A%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%80%E4%BB%8B.html" class="post-meta-item leancloud_visitors" data-flag-title="JVM堆内存及垃圾回收简介" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/blog/JVM%E5%A0%86%E5%86%85%E5%AD%98%E5%8F%8A%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%80%E4%BB%8B.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/blog/JVM%E5%A0%86%E5%86%85%E5%AD%98%E5%8F%8A%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%80%E4%BB%8B.html" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>30k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>27 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们知道在JVM内存模型中，堆是十分重要的一块，堆是内存占用最大，管理最复杂的一个区域，其用途就是存放生成的对象实例，所有的对象都会在堆上进行分配使用。</p><p>JDK1.8后，字符串常量池从永久代剥离了出来，也存放在了堆上。</p><h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="堆内存结构"><a href="#堆内存结构" class="headerlink" title="堆内存结构"></a>堆内存结构</h2><p>我们来看一下堆内存结构，JDK1.8后JVM堆内存结构如下图：</p><p><img data-src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-420.png" alt="upload successful"></p><p>可以看到堆内存分为年轻代（Young Generation）、年老代（Old Generation）及元空间（MetaData Space）。</p><p>PS:JDK8 完全移除永久代(Permanent Generation), 取而代之的是元空间MetaData Space（JVM使用本地内存，存放类的元数据）。</p><p>年轻代（Young Generation）又分为 Eden Space 和 Survivor Space，其中Survivor区有两部分构成 Survivor 1 和 Survivor 2 。</p><p>JVM虚拟机默认Eden区和两块Survivor区的内存比例为8:1:1。</p><h2 id="GC流程"><a href="#GC流程" class="headerlink" title="GC流程"></a>GC流程</h2><p>年轻代内存的大致使用过程为：</p><pre><code>年轻代将内存分为Eden和2块Survivor区（分别叫from和to）。

一般情况下，新创建的对象都会被分配到Eden区(一些大对象特殊处理),这些对象经过第一次Minor GC后，如果仍然存活，将会被移到Survivor区。

对象在Survivor区中每熬过一次Minor GC，年龄就会增加1岁，当它的年龄增加到一定程度时，就会被移动到年老代中。

在GC开始的时候，对象只会存在于Eden区和名为“From”的Survivor区，Survivor区“To”是空的。

紧接着进行GC，Eden区中所有存活的对象都会被复制到“To”，而在“From”区中，仍存活的对象会根据他们的年龄值来决定去向。年龄达到一定值的对象会被移动到年老代中，没有达到阈值的对象会被复制到“To”区域。

经过这次GC后，Eden区和From区已经被清空。这个时候，“From”和“To”会交换他们的角色，也就是新的“To”就是上次GC前的“From”，新的“From”就是上次GC前的“To”。不管怎样，都会保证名为To的Survivor区域是空的。

经过Minor GC之后，如果Survivor存放不下存活的对象，对象就会通过分配担保机制进入老年代，而如果老年代空间还不够，就会进行Full GC。

Minor GC会一直重复这样的过程，如果在Survivor空间中相同年龄所有对象大小的总和大于Survivor空间的一半，年龄大于或等于该年龄的对象就可以直接进入老年代。
</code></pre><p>因为年轻代中的对象基本都是朝生夕死的(80%以上)，所以在年轻代的垃圾回收算法使用的是复制算法，复制算法的基本思想就是将内存分为两块，每次只用其中一块，当这一块内存用完，就将还活着的对象复制到另外一块上面。复制算法不会产生内存碎片。</p><p>因此对象进入年老代有以下4种情况：</p><ul><li>经过Minor GC后，Survivor区存放不下存活的对象进入年老代。</li><li>对象长期存活，当年龄达到一定阈值后进入年老代，默认15。年龄阈值，可以通过-XX:MaxTenuringThreshold来设置。</li><li>大对象直接进入年老代，通过 -XX:PretenureSizeThreshold 参数可以进行设置多大的对象直接在年老代进行分配，从而避免大对象在年轻代（Eden和Survivor区）发生大量内存赋值操作。</li><li>如果在Survivor空间中相同年龄所有对象大小的总和大于Survivor空间的一半，年龄大于或等于该年龄的对象就可以直接进入老年代。（动态对象年龄绑定）</li></ul><p>GC的大致回收流程如下图：</p><p><img data-src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-421.png" alt="upload successful"></p><p>GC的回收分为垃圾的收集和回收两部分，收集和回收都涉及到一些算法逻辑，我们来整理下。</p><h2 id="垃圾收集算法"><a href="#垃圾收集算法" class="headerlink" title="垃圾收集算法"></a>垃圾收集算法</h2><p>JVM中常用的垃圾收集算法大致有两种，引用计数法和根搜索法。</p><ol><li><p>引用计数法</p><p>引用计数法本质是给对象添加引用计数器，当引用对象时计数器+1，引用失效时，计数器-1，当计数器等于0时，对象失效，内存可以被回收。</p><p>但会有一个问题，如果A对象引用B对象，同时B对象又引用A对象，但它们都不会再被系统使用，则它们可认为为垃圾，但是它们的引用计数是永不为0的，因此该方法永远也不会将其标位垃圾。</p><p>优点：实现简单高效。</p><p>缺点：对象之间的互相循环引用问题不好解决。</p></li><li><p>根搜索法</p><p>通过GC roots可达的对象路径称为引用链（reference chain），当一个对象没有引用链时（即从GC roots不可达）则视为不可用对象，内存可以被回收。</p><p>JVM主要使用根搜索法进行垃圾收集。</p><p>那在JVM中，哪些对象可以视为GC roots呢？</p><ul><li><p>虚拟机栈中（即栈帧中的本地变量）的引用对象；</p></li><li><p>本地方法栈中的引用对象；</p></li><li><p>方法区中的静态变量引用的对象和常量池中引用的对象。</p></li></ul></li></ol><h2 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h2><ol><li><p>标记-清除算法</p><p>分两步进行，第一步标记出可以回收的对象，第二步统一清理可以回收的对象内存。</p><p>缺点：如果在被标记后直接对对象进行清除，会带来另一个新的问题——内存碎片化。如果下次有比较大的对象实例需要在堆上分配较大的内存空间时，可能会出现无法找到足够的连续内存而不得不再次触发垃圾回收。</p></li><li><p>复制算法</p><p>此GC算法实际上解决了标记-清除算法带来的“内存碎片化”问题。首先还是先标记处待回收内存和不用回收的内存，下一步将不用回收的内存复制到新的内存区域，这样旧的内存区域就可以全部回收，而新的内存区域则是连续的。</p><p>缺点：就是会损失掉部分系统内存，因为你总要腾出一部分内存用于复制。</p></li><li><p>标记-整理算法</p><p>标记-压缩算法首先还是“标记”，标记过后，将不用回收的内存对象压缩到内存一端，此时即可直接清除边界处的内存，这样就能避免复制算法带来的效率问题，同时也能避免内存碎片化的问题。</p></li><li><p>分代收集算法</p><p>对于JVM堆内存的垃圾回收，可以认为是分代收集算法。</p><p>对于年轻代，大部分对象都不会存活，所以在新生代中使用复制算法较为高效。</p><p>而对于年老代来讲，大部分对象可能会继续存活下去，如果此时还是利用复制算法，效率则会降低，此时使用标记-整理算法，不仅提高效率，更节约内存。</p></li></ol><p>当然，具体使用哪种垃圾回收算法，也和垃圾收集器的实现有具体关系。</p><h2 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h2><p>再来看一下JVM的几种垃圾收集器。</p><p>目前JVM有7种作用于不同分代的垃圾收集器。如下图：</p><p><img data-src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-422.png" alt="upload successful"></p><p>上图两个垃圾收集器之间的连线表示它们可以搭配使用。</p><ol><li><p>Serial收集器</p><p>Serial收集器是最基本、发展历史最悠久的收集器。是单线程的收集器。它在进行垃圾收集时，必须暂停其他所有的工作线程，直到它收集完成。</p><p>Serial收集器依然是虚拟机运行在Client模式下默认新生代（年轻代）收集器，对于运行在Client模式下的虚拟机来说是一个很好的选择。</p></li><li><p>ParNew收集器</p><p>ParNew收集器其实就是Serial收集器的多线程版本，除了使用多线程进行垃圾收集之外，其余行为包括Serial收集器可用的所有控制参数、收集算法、Stop The World、对象分配规则、回收策略等都与Serial 收集器完全一样。</p><p>ParNew收集器是许多运行在Server模式下的虚拟机中首选新生代收集器，其中有一个与性能无关但很重要的原因是，除Serial收集器之外，目前只有ParNew它能与CMS收集器配合工作。</p></li><li><p>Parallel Scavenge（并行回收）收集器</p><p>Parallel Scavenge收集器是一个新生代收集器，它也是使用复制算法的收集器，又是并行的多线程收集器。</p><p>该收集器的目标是达到一个可控制的吞吐量（Throughput）。所谓吞吐量就是CPU用于运行用户代码的时间与CPU总消耗时间的比值，即 吞吐量=运行用户代码时间/（运行用户代码时间+垃圾收集时间）。</p><p>停顿时间越短就越适合需要与用户交互的程序，良好的响应速度能提升用户体验，而高吞吐量则可用高效率地利用CPU时间，尽快完成程序的运算任务，主要适合在后台运算而不需要太多交互的任务。</p><p>Parallel Scavenge收集器提供两个参数用于精确控制吞吐量，分别是控制最大垃圾收起停顿时间的 -XX:MaxGCPauseMillis参数以及直接设置吞吐量大小的-XX:GCTimeRatio参数</p><p>Parallel Scavenge收集器还有一个参数：-XX:+UseAdaptiveSizePolicy。这是一个开关参数，当这个参数打开后，就不需要手工指定新生代的大小（-Xmn）、Eden与Survivor区的比例（-XX:SurvivorRatio）、晋升老年代对象年龄（-XX:PretenureSizeThreshold）等细节参数，只需要把基本的内存数据设置好（如-Xmx设置最大堆），然后使用MaxGVPauseMillis参数或GCTimeRation参数给虚拟机设立一个优化目标。</p><p>自适应调节策略也是Parallel Scavenge收集器与ParNew收集器的一个重要区别。</p></li><li><p>Serial Old 收集器</p><p>Serial Old是Serial收集器的老年代版本，它同样是一个单线程收集器，使用标记整理算法。这个收集器的主要意义也是在于给Client模式下的虚拟机使用。</p><p>如果在Server模式下，主要两大用途：</p><p>（1）在JDK1.5以及之前的版本中与Parallel Scavenge收集器搭配使用。</p><p>（2）作为CMS收集器的后备预案，在并发收集发生Concurrent Mode Failure时使用。</p></li><li><p>Parallel Old 收集器</p><p>Parallel Old 是Parallel Scavenge收集器的老年代版本，使用多线程和“标记-整理”算法。这个收集器在1.6中才开始提供。</p></li><li><p>CMS收集器</p><p>CMS(Concurrent Mark Sweep)收集器是一种以获取最短回收停顿时间为目标的收集器。目前很大一部分的Java应用集中在互联网站或者B/S系统的服务端上，这类应用尤其重视服务器的响应速度，希望系统停顿时间最短，以给用户带来较好的体验。CMS收集器就非常符合这类应用的需求。</p><p>CMS收集器是基于“标记-清除”算法实现的。它的运作过程相对前面几种收集器来说更复杂一些，整个过程分为4个步骤：</p><p>（1）初始标记</p><p>（2）并发标记</p><p>（3）重新标记</p><p>（4）并发清除</p><p>其中，初始标记、重新标记这两个步骤仍然需要“Stop The World”.</p><p>CMS收集器主要优点：并发收集，低停顿。</p><p>CMS三个明显的缺点：</p><p>（1）CMS收集器对CPU资源非常敏感。CPU个数少于4个时，CMS对于用户程序的影响就可能变得很大，为了应付这种情况，虚拟机提供了一种称为“增量式并发收集器”的CMS收集器变种。所做的事情和单CPU年代PC机操作系统使用抢占式来模拟多任务机制的思想。</p><p>（2）CMS收集器无法处理浮动垃圾，可能出现“Concurrent Mode Failure”失败而导致另一次Full GC的产生。在JDK1.5的默认设置下，CMS收集器当老年代使用了68%的空间后就会被激活，这是一个偏保守的设置，如果在应用中老年代增长不是太快，可以适当调高参数-XX:CMSInitiatingOccupancyFraction的值来提高触发百分比，以便降低内存回收次数从而获取更好的性能，在JDK1.6中，CMS收集器的启动阀值已经提升至92%。</p><p>（3）CMS是基于“标记-清除”算法实现的收集器，收集结束时会有大量空间碎片产生。空间碎片过多，可能会出现老年代还有很大空间剩余，但是无法找到足够大的连续空间来分配当前对象，不得不提前触发FullGC。为了解决这个问题，CMS收集器提供了一个-XX:+UseCMSCompactAtFullCollection开关参数（默认就是开启的），用于在CMS收集器顶不住要进行FullGC时开启内存碎片合并整理过程，内存整理的过程是无法并发的，空间碎片问题没有了，但停顿时间变长了。虚拟机设计者还提供了另外一个参数-XX:CMSFullGCsBeforeCompaction,这个参数是用于设置执行多少次不压缩的Full GC后，跟着来一次带压缩的Full GC（默认值为0，表示每次进入Full GC时都进行碎片整理）。</p></li><li><p>G1收集器</p><p>G1收集器的优势：</p><p>（1）并行与并发</p><p>（2）分代收集</p><p>（3）空间整理 （标记——整理算法，复制算法）</p><p>（4）可预测的停顿（G1除处理追求低停顿外，还能建立可预测的停顿时间模型，能让使用者明确指定在一个长度为M毫秒的时间片段内，消耗在垃圾收集上的时间不得超过N毫秒，这几乎已经实现Java（RTSJ）的垃圾收集器的特征）</p><p>备注：</p><blockquote><p>The Real-time Specification for Java (RTSJ) is an open specification that augments the Java language to open the door more widely to using the language to build real-time systems (see Related topics). Implementing the RTSJ requires support in the operating system, the JRE, and the Java Class Library (JCL).</p></blockquote><p>详见：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.ibm.com/developerworks/library/j-rtj1/index.html">RTSJ</a> 中的Garbage collection的规范。</p><p>使用G1收集器时，Java堆的内存布局是整个规划为多个大小相等的独立区域（Region）,虽然还保留有新生代和老年代的概念，但新生代和老年代不再是物理隔离的了，它们都是一部分Region的集合。</p><p>G1收集器之所以能建立可预测的停顿时间模型，是因为它可以有计划地避免在整个Java堆中进行全区域的垃圾收集。G1跟踪各个Region里面的垃圾堆积的价值大小（回收所获取的空间大小以及回收所需要的时间的经验值），在后台维护一个优先列表，每次根据允许的收集时间，优先回收价值最大的Region（这也就是Garbage-First名称的又来）。这种使用Region划分内存空间以及有优先级的区域回收方式，保证了G1收集器在有限的时间内可以获取尽量可能高的收集效率。</p><p>G1 内存“化整为零”的思路：</p><p>在GC根节点的枚举范围中加入Remembered Set即可保证不对全堆扫描也不会遗漏。</p><p>如果不计算维护Remembered Set的操作，G1收集器的运作大致可划分为一下步骤：</p><p>（1）初始标记</p><p>（2）并发标记</p><p>（3）最终标记</p><p>（4）筛选回收</p></li></ol><p>参考：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cnblogs.com/chengxuyuanzhilu/p/7088316.html">https://www.cnblogs.com/chengxuyuanzhilu/p/7088316.html</a></p><h2 id="JVM的一些参数"><a href="#JVM的一些参数" class="headerlink" title="JVM的一些参数"></a>JVM的一些参数</h2><p>我们再来看下JVM的一些常用参数设置。</p><h3 id="JVM的基础参数"><a href="#JVM的基础参数" class="headerlink" title="JVM的基础参数"></a>JVM的基础参数</h3><ul><li>-Xmx2048m：设置JVM最大堆内存为2048M。</li><li>-Xms2048m：设置JVM初始堆内存为2048M。此值可以设置与-Xmx相同，以避免每次垃圾回收完成后JVM重新分配内存。</li><li>-Xss128k：设置每个线程的栈大小。JDK5.0以后每个线程栈大小为1M，之前每个线程栈大小为256K。应当根据应用的线程所需内存大小进行调整。在相同物理内存下，减小这个值能生成更多的线程。但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在3000~5000左右。需要注意的是：当这个值被设置的较大（例如&gt;2MB）时将会在很大程度上降低系统的性能。</li><li>-Xmn1g：设置年轻代大小为1G。在整个堆内存大小确定的情况下，增大年轻代将会减小年老代，反之亦然。此值关系到JVM垃圾回收，对系统性能影响较大，官方推荐配置为整个堆大小的3/8。</li><li>-XX:NewSize=1024m：设置年轻代初始值为1024M。</li><li>-XX:MaxNewSize=1024m：设置年轻代最大值为1024M。</li><li>-XX:PermSize=256m：设置持久代初始值为256M。（1.7以下JDK版本有效）</li><li>-XX:MaxPermSize=256m：设置持久代最大值为256M。（1.7以下JDK版本有效）</li><li>-XX:MetaspaceSize=8m：初始元数据空间大小，达到该值就会触发垃圾收集进行类型卸载，同时GC会对该值进行调整：如果释放了大量的空间，就适当降低该值；如果释放了很少的空间，那么在不超过MaxMetaspaceSize时，适当提高该值。（1.7以上JDK版本有效）</li><li>-XX:MaxMetaspaceSize=50m：元数据最大空间大小，默认是没有限制的。（1.7以上JDK版本有效）</li><li>-XX:NewRatio=4：设置年轻代（包括1个Eden和2个Survivor区）与年老代的比值。表示年轻代比年老代为1:4。</li><li>-XX:SurvivorRatio=4：设置年轻代中Eden区与Survivor区的比值。表示2个Survivor区与1个Eden区的比值为2:4，即1个Survivor区占整个年轻代大小的1/6。</li><li>-XX:MaxTenuringThreshold=7：表示一个对象如果在Survivor区（救助空间）移动了7次还没有被垃圾回收就进入年老代。如果设置为0的话，则年轻代对象不经过Survivor区，直接进入年老代，对于需要大量常驻内存的应用，这样做可以提高效率。如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象在年轻代存活时间，增加对象在年轻代被垃圾回收的概率，减少Full GC的频率，这样做可以在某种程度上提高服务稳定性。</li><li>-XX:MinMetaspaceFreeRatio，在GC之后，最小的Metaspace剩余空间容量的百分比，减少为分配空间所导致的垃圾收集。（1.7以上JDK版本有效）</li><li>-XX:MaxMetaspaceFreeRatio，在GC之后，最大的Metaspace剩余空间容量的百分比，减少为释放空间所导致的垃圾收集。（1.7以上JDK版本有效）</li></ul><p>PS:可以看到-Xmn，-XX:NewSize/-XX:MaxNewSize，-XX:NewRatio 3组参数都可以影响年轻代的大小，它们混合使用生效的优先级为：</p><pre><code>高优先级：-XX:NewSize/-XX:MaxNewSize 
中优先级：-Xmn（默认等效  -Xmn=-XX:NewSize=-XX:MaxNewSize=?） 
低优先级：-XX:NewRatio 
</code></pre><p>推荐使用-Xmn参数。</p><h3 id="JVM垃圾回收参数"><a href="#JVM垃圾回收参数" class="headerlink" title="JVM垃圾回收参数"></a>JVM垃圾回收参数</h3><ul><li>-XX:+UseSerialGC：设置串行收集器。</li><li>-XX:+UseParallelGC：设置为并行收集器。此配置仅对年轻代有效。即年轻代使用并行收集，而年老代仍使用串行收集。</li><li>-XX:ParallelGCThreads=20：配置并行收集器的线程数，即：同时有多少个线程一起进行垃圾回收。此值建议配置与CPU数目相等。</li><li>-XX:+UseParallelOldGC：配置年老代垃圾收集方式为并行收集。JDK6.0开始支持对年老代并行收集。</li><li>-XX:MaxGCPauseMillis=100：设置每次年轻代垃圾回收的最长时间（单位毫秒）。如果无法满足此时间，JVM会自动调整年轻代大小，以满足此时间。</li><li>-XX:+UseAdaptiveSizePolicy：设置此选项后，并行收集器会自动调整年轻代Eden区大小和Survivor区大小的比例，以达成目标系统规定的最低响应时间或者收集频率等指标。此参数建议在使用并行收集器时，一直打开。</li><li>-XX:+UseConcMarkSweepGC：即CMS收集，设置年老代为并发收集。CMS收集是JDK1.4后期版本开始引入的新GC算法。它的主要适合场景是对响应时间的重要性需求大于对吞吐量的需求，能够承受垃圾回收线程和应用线程共享CPU资源，并且应用中存在比较多的长生命周期对象。CMS收集的目标是尽量减少应用的暂停时间，减少Full GC发生的几率，利用和应用程序线程并发的垃圾回收线程来标记清除年老代内存。</li><li>-XX:+UseParNewGC：设置年轻代为并发收集。可与CMS收集同时使用。JDK5.0以上，JVM会根据系统配置自行设置，所以无需再设置此参数。</li><li>-XX:CMSFullGCsBeforeCompaction=0：由于并发收集器不对内存空间进行压缩和整理，所以运行一段时间并行收集以后会产生内存碎片，内存使用效率降低。此参数设置运行0次Full GC后对内存空间进行压缩和整理，即每次Full GC后立刻开始压缩和整理内存。</li><li>-XX:+UseCMSCompactAtFullCollection：打开内存空间的压缩和整理，在Full GC后执行。可能会影响性能，但可以消除内存碎片。</li><li>-XX:+CMSIncrementalMode：设置为增量收集模式。一般适用于单CPU情况。</li><li>-XX:CMSInitiatingOccupancyFraction=70：表示年老代内存空间使用到70%时就开始执行CMS收集，以确保年老代有足够的空间接纳来自年轻代的对象，避免Full GC的发生。</li><li>-XX:+ScavengeBeforeFullGC：年轻代GC优于Full GC执行。</li><li>-XX:+DisableExplicitGC：不响应 System.gc() 代码。</li><li>-XX:+UseThreadPriorities：启用本地线程优先级API。即使 java.lang.Thread.setPriority() 生效，不启用则无效。</li><li>-XX:SoftRefLRUPolicyMSPerMB=0：软引用对象在最后一次被访问后能存活0毫秒（JVM默认为1000毫秒）。</li><li>-XX:TargetSurvivorRatio=90：允许90%的Survivor区被占用（JVM默认为50%）。提高对于Survivor区的使用率。</li><li>-XX:+UseG1GC: 设置使用G1垃圾回收器（1.7以上JDK版本有效）</li><li>-XX:G1HeapRegionSize=n:设置g1 region大小，不设置的话自己会根据堆大小算，目标是根据最小堆内存划分2048个区域（1.7以上JDK版本有效）</li></ul><h3 id="JVM其它参数"><a href="#JVM其它参数" class="headerlink" title="JVM其它参数"></a>JVM其它参数</h3><ul><li>-XX:+CITime：打印消耗在JIT编译的时间。</li><li>-XX:ErrorFile=./hs_err_pid.log：保存错误日志或数据到指定文件中。</li><li>-XX:HeapDumpPath=./java_pid.hprof：指定Dump堆内存时的路径。</li><li>-XX:+HeapDumpOnOutOfMemoryError：当首次遭遇内存溢出时Dump出此时的堆内存。</li><li>-XX:OnError=”;”：出现致命ERROR后运行自定义命令。</li><li>-XX:OnOutOfMemoryError=”;”：当首次遭遇内存溢出时执行自定义命令。</li><li>-XX:+PrintClassHistogram：按下 Ctrl+Break 后打印堆内存中类实例的柱状信息，同JDK的 jmap -histo 命令。</li><li>-XX:+PrintConcurrentLocks：按下 Ctrl+Break 后打印线程栈中并发锁的相关信息，同JDK的 jstack -l 命令。</li><li>-XX:+PrintCompilation：当一个方法被编译时打印相关信息。</li><li>-XX:+PrintGC：每次GC时打印相关信息。</li><li>-XX:+PrintGCDetails：每次GC时打印详细信息。</li><li>-XX:+PrintGCTimeStamps：打印每次GC的时间戳。</li><li>-XX:+TraceClassLoading：跟踪类的加载信息。</li><li>-XX:+TraceClassLoadingPreorder：跟踪被引用到的所有类的加载信息。</li><li>-XX:+TraceClassResolution：跟踪常量池。</li><li>-XX:+TraceClassUnloading：跟踪类的卸载信息。</li><li>-client：设置JVM使用Client模式，特点是启动速度比较快，但运行时性能和内存管理效率不高，通常用于客户端应用程序或开发调试；在32位环境下直接运行Java程序默认启用该模式。</li><li>-server：设置JVM使Server模式，特点是启动速度比较慢，但运行时性能和内存管理效率很高，适用于生产环境。在具有64位能力的JDK环境下默认启用该模式。</li></ul><p>PS：关于参数名称定义如下。</p><pre><code>标准参数（-），所有JVM都必须支持这些参数的功能，而且向后兼容；
非标准参数（-X），默认JVM实现这些参数的功能，但是并不保证所有JVM实现都满足，且不保证向后兼容；
非稳定参数（-XX），此类参数各个JVM实现会有所不同，将来可能会不被支持，需要慎重使用；
</code></pre><p>参考：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/kthq/article/details/8618052">https://blog.csdn.net/kthq/article/details/8618052</a></p><h2 id="各个区域的OOM"><a href="#各个区域的OOM" class="headerlink" title="各个区域的OOM"></a>各个区域的OOM</h2><p>我们来看下JVM各个区域的OOM。</p><p><strong>堆的OOM</strong></p><p>我们创建如下类，进行测试。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JvmTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">oomTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">		List&lt;JvmTest&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">				list.add(<span class="keyword">new</span> JvmTest());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;  </span><br><span class="line"> 	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">new</span> JvmTest().oomTest();</span><br><span class="line">	&#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后可以看到抛出如下异常：</p><p><img data-src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-423.png" alt="upload successful"></p><p>这也是非常常见的一种OOM异常。出现的原因可能是创建了大量大对象、一些流未及时关闭等，导致堆内存溢出。</p><p>出现这种情况，必须考虑程序的优化解决方法。而不是单纯的通过-Xmn参数增大内存来解决。</p><p><strong>栈的OOM</strong></p><p>当栈深度超过虚拟机分配给线程的栈大小时，就会出现栈的溢出异常。</p><p>我们创建测试类，来看一下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JvmTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">stackOverTest</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(n==<span class="number">1</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> stackOverTest(n-<span class="number">1</span>)+<span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">new</span> JvmTest().stackOverTest(<span class="number">200000</span>);</span><br><span class="line">	&#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后可以看到如下异常：</p><p><img data-src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-424.png" alt="upload successful"></p><p>这种异常一般是调用递归或者死循环等产生的，导致栈深度超过虚拟机分配给线程的栈大小。</p><p>当然可以通过-Xss参数控制每个线程的栈大小来解决，但通常情况下，应检查程序，减少递归的使用。</p><p><strong>关于Metaspace与PermGen（永久代）</strong></p><p>JDK1.8移除了PermGen（永久代），取而代之的是Metaspace（元空间），元空间与永久代之间最大的区别在于：元空间并不在虚拟机中，而是使用本地内存。因此，默认情况下，元空间的大小仅受本地内存限制。</p><p>我们在JDK1.8环境下，设置Metaspace的大小，进行测试。(-XX:MetaspaceSize=5M -XX:MaxMetaspaceSize=5M)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JvmTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MetaSpaceOOMTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">			Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">			enhancer.setSuperclass(JvmTest.class);</span><br><span class="line">			enhancer.setUseCache(<span class="keyword">false</span>);</span><br><span class="line">			enhancer.setCallback(</span><br><span class="line">					<span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">						<span class="meta">@Override</span></span><br><span class="line">						<span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">							<span class="keyword">return</span> methodProxy.invokeSuper(o,objects);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">			);</span><br><span class="line">			enhancer.create();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">new</span> JvmTest().MetaSpaceOOMTest();</span><br><span class="line">	&#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后可以看到如下异常：</p><p><img data-src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-425.png" alt="upload successful"></p><p>这种问题出现较少，如果出现一般为动态代理生成大量class类引起的问题。</p><p>我们在JDK1.6环境下，设置PermGen（永久代）大小，进行测试。（-XX:PermSize=10m -XX:MaxPermSize=10m）</p><p>测试方法同上。</p><p>可以看到日志输出如下：</p><p><img data-src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-426.png" alt="upload successful"></p><p>由于项目大多数JDK版本都在8及以上，故这种OOM异常已经很少在见到了。</p><h2 id="JVM-日志"><a href="#JVM-日志" class="headerlink" title="JVM 日志"></a>JVM 日志</h2><p>我们再来看下JVM的垃圾回收日志，并简单解读下。我们这儿主要来看新的JVM（1.8及其后）的GC日志。</p><p>我们在运行时添加如下参数： -XX:-PrintGCDetails</p><p>我们用上面的 JvmTest类里的oomTest方法来进行测试。</p><p>可以看到如下一些GC运行日志和OOM的dump日志。</p><p>我们先来看下GC的运行日志部分：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [PSYoungGen: 207268K-&gt;200192K(339968K)] 879015K-&gt;879170K(1489408K), 0.8137540 secs] [Times: user=2.95 sys=0.06, real=0.81 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 339968K-&gt;243200K(339456K)] 1292739K-&gt;1292955K(1488896K), 0.8972164 secs] [Times: user=3.18 sys=0.20, real=0.90 secs] </span><br><span class="line">[Full GC (Ergonomics) [PSYoungGen: 243200K-&gt;0K(339456K)] [ParOldGen: 1049755K-&gt;1110054K(1722880K)] 1292955K-&gt;1110054K(2062336K), [Metaspace: 3502K-&gt;3502K(1056768K)], 7.8097561 secs] [Times: user=16.27 sys=0.19, real=7.81 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 96256K-&gt;96384K(424448K)] 1206310K-&gt;1206438K(2147328K), 0.3838048 secs] [Times: user=1.39 sys=0.05, real=0.38 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 192640K-&gt;192672K(425472K)] 1302694K-&gt;1302726K(2148352K), 0.6567791 secs] [Times: user=2.53 sys=0.00, real=0.66 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 303776K-&gt;303840K(430080K)] 1824520K-&gt;1824584K(2152960K), 1.1635894 secs] [Times: user=4.29 sys=0.00, real=1.16 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 414944K-&gt;347136K(496640K)] 1935688K-&gt;1935808K(2219520K), 1.6472200 secs] [Times: user=5.76 sys=0.19, real=1.65 secs] </span><br><span class="line">[Full GC (Ergonomics) [PSYoungGen: 347136K-&gt;0K(496640K)] [ParOldGen: 1588672K-&gt;1661667K(2083840K)] 1935808K-&gt;1661667K(2580480K), [Metaspace: 3502K-&gt;3502K(1056768K)], 10.5294207 secs] [Times: user=23.63 sys=0.09, real=10.53 secs]</span><br></pre></td></tr></table></figure><ul><li>(Allocation Failure)：Allocation Failure表示向young generation(eden)给新对象申请空间，但是young generation(eden)剩余的合适空间不够所需的大小导致的GC。</li><li>[PSYoungGen: 207268K-&gt;200192K(339968K)] 879015K-&gt;879170K(1489408K), 0.8137540 secs] 这段分别表示 [年轻代: GC前内存容量 -&gt; GC后内存容量 (年轻代总容量)] GC前堆内存大小 -&gt; GC后堆内存大小(堆内存总大小),该内存区域GC耗时（与Times的real相等），单位是秒。</li><li>[Times: user=2.95 sys=0.06, real=0.81 secs] 这段分别表示用户态耗时，内核态耗时和总耗时。</li><li>Full GC (Ergonomics) 表明该次发生了Full GC，Ergonomics就是Full GC的原因，可以认为如果晋升到老生代的平均大小大于老生代的剩余大小，则认为需要一次full gc。某些垃圾回收器会负责自动的调解gc暂停时间和吞吐量之间的平衡，然后JVM虚拟机性能更好，因而会出现这种Full GC原因。</li><li>ParOldGen部分表示年老代的相关GC信息。</li><li>Metaspace部分表示元空间的相关GC信息。</li></ul><p>我们在GC相关源码(openjdk源码中gcCause.cpp文件)中还可以看到多种GC原因，如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;precompiled.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;gc/shared/gcCause.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">GCCause::to_string</span><span class="params">(GCCause::Cause cause)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (cause) &#123;</span><br><span class="line">    <span class="keyword">case</span> _java_lang_system_gc:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;System.gc()&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _full_gc_alot:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;FullGCAlot&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _scavenge_alot:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;ScavengeAlot&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _allocation_profiler:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Allocation Profiler&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _jvmti_force_gc:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;JvmtiEnv ForceGarbageCollection&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _gc_locker:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;GCLocker Initiated GC&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _heap_inspection:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Heap Inspection Initiated GC&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _heap_dump:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Heap Dump Initiated GC&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _wb_young_gc:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;WhiteBox Initiated Young GC&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _wb_conc_mark:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;WhiteBox Initiated Concurrent Mark&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _wb_full_gc:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;WhiteBox Initiated Full GC&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _update_allocation_context_stats_inc:</span><br><span class="line">    <span class="keyword">case</span> _update_allocation_context_stats_full:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Update Allocation Context Stats&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _no_gc:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;No GC&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _allocation_failure:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Allocation Failure&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _tenured_generation_full:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Tenured Generation Full&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _metadata_GC_threshold:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Metadata GC Threshold&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _metadata_GC_clear_soft_refs:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Metadata GC Clear Soft References&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _cms_generation_full:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;CMS Generation Full&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _cms_initial_mark:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;CMS Initial Mark&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _cms_final_remark:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;CMS Final Remark&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _cms_concurrent_mark:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;CMS Concurrent Mark&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _old_generation_expanded_on_last_scavenge:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Old Generation Expanded On Last Scavenge&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _old_generation_too_full_to_scavenge:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Old Generation Too Full To Scavenge&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _adaptive_size_policy:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Ergonomics&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _g1_inc_collection_pause:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;G1 Evacuation Pause&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _g1_humongous_allocation:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;G1 Humongous Allocation&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _dcmd_gc_run:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Diagnostic Command&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> _last_gc_cause:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;ILLEGAL VALUE - last gc cause - ILLEGAL VALUE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;unknown GCCause&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ShouldNotReachHere();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这儿就不在对上面的所有GC情况做详细介绍了，有兴趣的同学可以查阅相关资料了解。</p><p>gcCause相关资料：</p><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://hg.openjdk.java.net/jdk8u/hs-dev/hotspot/file/tip/src/share/vm/gc_interface/gcCause.cpp">openjdk-gcCause.cpp</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://netflix.github.io/spectator/en/latest/ext/jvm-gc-causes/">jvm-gcCause-info</a></li></ul><p>我们再来看下出现OOM后GC的dump日志部分。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Heap</span><br><span class="line"> PSYoungGen      total 584192K, used 10301K [0x0000000780700000, 0x00000007ba880000, 0x00000007c0000000)</span><br><span class="line">  eden space 257536K, 3% used [0x0000000780700000,0x000000078110f510,0x0000000790280000)</span><br><span class="line">  from space 326656K, 0% used [0x00000007a6980000,0x00000007a6980000,0x00000007ba880000)</span><br><span class="line">  to   space 347136K, 0% used [0x0000000790280000,0x0000000790280000,0x00000007a5580000)</span><br><span class="line"> ParOldGen       total 2083840K, used 2054113K [0x0000000701400000, 0x0000000780700000, 0x0000000780700000)</span><br><span class="line">  object space 2083840K, 98% used [0x0000000701400000,0x000000077e9f8790,0x0000000780700000)</span><br><span class="line"> Metaspace       used 3535K, capacity 4506K, committed 4864K, reserved 1056768K</span><br><span class="line">  class space    used 392K, capacity 394K, committed 512K, reserved 1048576K</span><br></pre></td></tr></table></figure><p>它们打印的JVM终止时Heap（堆内存）的信息，从该日志中我们能分析出JVM终止的一些原因。</p><p>可以看到PSYoungGen（年轻代） eden区使用了3%，（两个Survivor）from和to区使用了0%，ParOldGen（年老代） object space（对象区）使用了98%，Metaspace（元空间） class space（类加载区）的使用情况。</p><p>因此明显由于创建了大量对象，一直存在，无法被垃圾回收，导致内存空间用尽，出现OOM异常。</p><h2 id="JVM监控Demo"><a href="#JVM监控Demo" class="headerlink" title="JVM监控Demo"></a>JVM监控Demo</h2><p>现在有许多JVM监控工具，如JConsole、Java VisualVM等，我们这里不过多介绍。</p><p>我们自写一个监控Demo来看下JVM在内存使用过程中的一些变化特点。</p><p>来看下<code>java.lang.management</code>包下的一些类。</p><p><img data-src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-427.png" alt="upload successful"></p><ul><li>MemoryMXBean ： 它里面有两个方法 <code>getHeapMemoryUsage</code> （获取堆内存使用情况）和<code>getNonHeapMemoryUsage</code>（获取非堆内存使用情况），返回<code>MemoryUsage</code>对象。</li><li>MemoryUsage：包含<code>init</code>（初始化了多少内存）、<code>used</code>（使用了多少内存）、<code>committed</code>（申请了多少内存）、<code>max</code>（最大内存）信息。</li><li>MemoryPoolMXBean：这里包含young（eden和survivor）、old等内存区的使用情况，我们可以通过 <code>ManagementFactory.getMemoryPoolMXBeans()</code> 获取到一个 <code>MemoryPoolMXBean</code> 列表，<code>MemoryPoolMXBean</code>里还有一个<code>getName</code>方法可以获得当前区域的名称。</li><li>GarbageCollectorMXBean：这个是垃圾收集相关的Bean，可以通过<code>ManagementFactory.getGarbageCollectorMXBeans()</code>获取其列表。其<code>getName</code>方法可以获得垃圾收集器的名称，<code>getCollectionCount</code>可以获得当前已经进行了多少次垃圾收集，<code>getCollectionTime</code>返回垃圾收集时间。</li></ul><p>我们写一个测试类来看一下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JVMMonitorMemoryTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">//定时任务线程</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ScheduledExecutorService executorService = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> ScheduledFuture future = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> JvmTest jvmTest = <span class="keyword">new</span> JvmTest();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doMonitor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        future = executorService.scheduleAtFixedRate(()-&gt;&#123;</span><br><span class="line">            JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">            MemoryMXBean memoryMXBean = ManagementFactory.getMemoryMXBean();</span><br><span class="line">            jsonObject.put(<span class="string">&quot;totalMaxMemery&quot;</span>, memoryMXBean.getHeapMemoryUsage().getMax()&gt;&gt;<span class="number">10</span>&gt;&gt;<span class="number">10</span>);</span><br><span class="line">            jsonObject.put(<span class="string">&quot;totalUsedMemery&quot;</span>, memoryMXBean.getHeapMemoryUsage().getUsed()&gt;&gt;<span class="number">10</span>&gt;&gt;<span class="number">10</span>);</span><br><span class="line">            jsonObject.put(<span class="string">&quot;totalInitMemery&quot;</span>, memoryMXBean.getHeapMemoryUsage().getInit()&gt;&gt;<span class="number">10</span>&gt;&gt;<span class="number">10</span>);</span><br><span class="line">            <span class="comment">//这里会返回老年代，新生代等内存区的使用情况</span></span><br><span class="line">            List&lt;MemoryPoolMXBean&gt; memoryPoolMXBeans = ManagementFactory.getMemoryPoolMXBeans();</span><br><span class="line">            memoryPoolMXBeans.forEach((pool) -&gt; &#123;</span><br><span class="line">                String poolName = pool.getName().trim();</span><br><span class="line">                <span class="keyword">long</span> max = pool.getUsage().getMax()&gt;&gt;<span class="number">10</span>&gt;&gt;<span class="number">10</span>;</span><br><span class="line">                <span class="keyword">long</span> used = pool.getUsage().getUsed()&gt;&gt;<span class="number">10</span>&gt;&gt;<span class="number">10</span>;</span><br><span class="line">                <span class="keyword">long</span> init = pool.getUsage().getInit()&gt;&gt;<span class="number">10</span>&gt;&gt;<span class="number">10</span>;</span><br><span class="line">                <span class="keyword">long</span> maxPeak = pool.getPeakUsage().getMax()&gt;&gt;<span class="number">10</span>&gt;&gt;<span class="number">10</span>;</span><br><span class="line">                <span class="keyword">long</span> usedPeak = pool.getPeakUsage().getUsed()&gt;&gt;<span class="number">10</span>&gt;&gt;<span class="number">10</span>;</span><br><span class="line">                <span class="keyword">long</span> initPeak = pool.getPeakUsage().getInit()&gt;&gt;<span class="number">10</span>&gt;&gt;<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">                JSONObject poolJSON = <span class="keyword">new</span> JSONObject();</span><br><span class="line">                poolJSON.put(<span class="string">&quot;max&quot;</span>, max);</span><br><span class="line">                poolJSON.put(<span class="string">&quot;used&quot;</span>, used);</span><br><span class="line">                poolJSON.put(<span class="string">&quot;init&quot;</span>, init);</span><br><span class="line">                poolJSON.put(<span class="string">&quot;maxPeak&quot;</span>, maxPeak);</span><br><span class="line">                poolJSON.put(<span class="string">&quot;usedPeak&quot;</span>, usedPeak);</span><br><span class="line">                poolJSON.put(<span class="string">&quot;initPeak&quot;</span>, initPeak);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="string">&quot;PS Eden Space&quot;</span>.equalsIgnoreCase(poolName))&#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;eden&quot;</span>, poolJSON);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;PS Survivor Space&quot;</span>.equalsIgnoreCase(poolName))&#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;survivor&quot;</span>, poolJSON);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;PS Old Gen&quot;</span>.equalsIgnoreCase(poolName))&#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;old&quot;</span>, poolJSON);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;Metaspace&quot;</span>.equalsIgnoreCase(poolName))&#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;metaspace&quot;</span>,poolJSON);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">//垃圾收集相关</span></span><br><span class="line">            List&lt;GarbageCollectorMXBean&gt; garbageCollectorMXBeans = ManagementFactory.getGarbageCollectorMXBeans();</span><br><span class="line">            garbageCollectorMXBeans.forEach(collector -&gt; &#123;</span><br><span class="line">                String gcName = collector.getName();</span><br><span class="line">                <span class="keyword">long</span> gcCount = collector.getCollectionCount();</span><br><span class="line">                <span class="keyword">long</span> gcTime = collector.getCollectionTime();</span><br><span class="line">                JSONObject gcJSON = <span class="keyword">new</span> JSONObject();</span><br><span class="line">                gcJSON.put(<span class="string">&quot;gcCount&quot;</span>, gcCount);</span><br><span class="line">                gcJSON.put(<span class="string">&quot;gcTime&quot;</span>, gcTime);</span><br><span class="line">                <span class="keyword">if</span>(gcName.toLowerCase().contains(<span class="string">&quot;scavenge&quot;</span>))&#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;edenGc&quot;</span>, gcJSON);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(gcName.toLowerCase().contains(<span class="string">&quot;marksweep&quot;</span>))&#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;oldGc&quot;</span>, gcJSON);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            System.out.println(JSON.toJSONString(jsonObject));</span><br><span class="line">        &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//调用生成对象的方法</span></span><br><span class="line">        jvmTest.test();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JVMMonitorMemoryTest jvmMonitorMemoryTest = <span class="keyword">new</span> JVMMonitorMemoryTest();</span><br><span class="line">        jvmMonitorMemoryTest.doMonitor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//创建一个方法不停生产对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JvmTest</span> </span>&#123;</span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		List&lt;JvmTest&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">				list.add(<span class="keyword">new</span> JvmTest());</span><br><span class="line">				<span class="keyword">if</span>(list.size()&gt;<span class="number">10000</span>)&#123;</span><br><span class="line">					list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">					TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">		    e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们运行后可以看到相关输出信息，即JVM堆内存变化情况及垃圾收集情况。</p><p>数字数据不是很直观，我们结合Echart图表，动态展示JVM相关信息，因此我们把项目改造下，结合WebSocket来实现。</p><p>项目大致结构如下：</p><p><img data-src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-428.png" alt="upload successful"></p><p>说一下里面的关键部分，MonitorJVMMemory.java（监控JVM内存变化类）和jvm-echart.js（Echart前端动态展示）。</p><p>MonitorJVMMemory相关代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket/jvm/monitor&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MonitorJVMMemory</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 日志</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MonitorJVMMemory.class);</span><br><span class="line">    <span class="comment">//定时任务线程</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ScheduledExecutorService executorService = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> ScheduledFuture future = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> JvmTest jvmTest = <span class="keyword">new</span> JvmTest();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * websocket会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Session session;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.session = session;</span><br><span class="line">        future = executorService.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">            MemoryMXBean memoryMXBean = ManagementFactory.getMemoryMXBean();</span><br><span class="line">            jsonObject.put(<span class="string">&quot;totalMaxMemery&quot;</span>, memoryMXBean.getHeapMemoryUsage().getMax() &gt;&gt; <span class="number">10</span> &gt;&gt; <span class="number">10</span>);</span><br><span class="line">            jsonObject.put(<span class="string">&quot;totalUsedMemery&quot;</span>, memoryMXBean.getHeapMemoryUsage().getUsed() &gt;&gt; <span class="number">10</span> &gt;&gt; <span class="number">10</span>);</span><br><span class="line">            jsonObject.put(<span class="string">&quot;totalInitMemery&quot;</span>, memoryMXBean.getHeapMemoryUsage().getInit() &gt;&gt; <span class="number">10</span> &gt;&gt; <span class="number">10</span>);</span><br><span class="line">            <span class="comment">//这里会返回老年代，新生代等内存区的使用情况，按需自取就好</span></span><br><span class="line">            List&lt;MemoryPoolMXBean&gt; memoryPoolMXBeans = ManagementFactory.getMemoryPoolMXBeans();</span><br><span class="line">            memoryPoolMXBeans.forEach((pool) -&gt; &#123;</span><br><span class="line">                String poolName = pool.getName().trim();</span><br><span class="line">                <span class="keyword">long</span> max = pool.getUsage().getMax() &gt;&gt; <span class="number">10</span> &gt;&gt; <span class="number">10</span>;</span><br><span class="line">                <span class="keyword">long</span> used = pool.getUsage().getUsed() &gt;&gt; <span class="number">10</span> &gt;&gt; <span class="number">10</span>;</span><br><span class="line">                <span class="keyword">long</span> init = pool.getUsage().getInit() &gt;&gt; <span class="number">10</span> &gt;&gt; <span class="number">10</span>;</span><br><span class="line">                <span class="keyword">long</span> maxPeak = pool.getPeakUsage().getMax() &gt;&gt; <span class="number">10</span> &gt;&gt; <span class="number">10</span>;</span><br><span class="line">                <span class="keyword">long</span> usedPeak = pool.getPeakUsage().getUsed() &gt;&gt; <span class="number">10</span> &gt;&gt; <span class="number">10</span>;</span><br><span class="line">                <span class="keyword">long</span> initPeak = pool.getPeakUsage().getInit() &gt;&gt; <span class="number">10</span> &gt;&gt; <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">                JSONObject poolJSON = <span class="keyword">new</span> JSONObject();</span><br><span class="line">                poolJSON.put(<span class="string">&quot;max&quot;</span>, max);</span><br><span class="line">                poolJSON.put(<span class="string">&quot;used&quot;</span>, used);</span><br><span class="line">                poolJSON.put(<span class="string">&quot;init&quot;</span>, init);</span><br><span class="line">                poolJSON.put(<span class="string">&quot;maxPeak&quot;</span>, maxPeak);</span><br><span class="line">                poolJSON.put(<span class="string">&quot;usedPeak&quot;</span>, usedPeak);</span><br><span class="line">                poolJSON.put(<span class="string">&quot;initPeak&quot;</span>, initPeak);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;PS Eden Space&quot;</span>.equalsIgnoreCase(poolName)) &#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;eden&quot;</span>, poolJSON);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;PS Survivor Space&quot;</span>.equalsIgnoreCase(poolName)) &#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;survivor&quot;</span>, poolJSON);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;PS Old Gen&quot;</span>.equalsIgnoreCase(poolName)) &#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;old&quot;</span>, poolJSON);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">//垃圾收集</span></span><br><span class="line">            List&lt;GarbageCollectorMXBean&gt; garbageCollectorMXBeans = ManagementFactory.getGarbageCollectorMXBeans();</span><br><span class="line">            garbageCollectorMXBeans.forEach(collector -&gt; &#123;</span><br><span class="line">                String gcName = collector.getName();</span><br><span class="line">                <span class="keyword">long</span> gcCount = collector.getCollectionCount();</span><br><span class="line">                <span class="keyword">long</span> gcTime = collector.getCollectionTime();</span><br><span class="line">                JSONObject gcJSON = <span class="keyword">new</span> JSONObject();</span><br><span class="line">                gcJSON.put(<span class="string">&quot;gcCount&quot;</span>, gcCount);</span><br><span class="line">                gcJSON.put(<span class="string">&quot;gcTime&quot;</span>, gcTime);</span><br><span class="line">                <span class="keyword">if</span> (gcName.toLowerCase().contains(<span class="string">&quot;scavenge&quot;</span>)) &#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;edenGc&quot;</span>, gcJSON);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gcName.toLowerCase().contains(<span class="string">&quot;marksweep&quot;</span>)) &#123;</span><br><span class="line">                    jsonObject.put(<span class="string">&quot;oldGc&quot;</span>, gcJSON);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                session.getBasicRemote().sendText(jsonObject.toJSONString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        jvmTest.test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acceptMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;Accept&gt;&gt;&gt;&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeSession</span><span class="params">(CloseReason closeReason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.destory();</span><br><span class="line">        logger.info(closeReason.getReasonPhrase());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">errorHandler</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.destory();</span><br><span class="line">        logger.info(<span class="string">&quot;MonitorJVMMemory websocket error ：&quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (future != <span class="keyword">null</span> &amp;&amp; !future.isCancelled()) &#123;</span><br><span class="line">                future.cancel(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">                session.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;destory&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent servletContextEvent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent servletContextEvent)</span> </span>&#123;</span><br><span class="line">        jvmTest.stop();</span><br><span class="line">        executorService.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到我们使用了Websocket，当连接Open后，使用定长线程池，里面维护一个每隔1s调用一次的方法，来查看当前内存情况，并使用<code>jvmTest.test()</code>来生成测试对象。</p><p>线程池里运行的线程执行的就是我们上面JVMMonitorMemoryTest类的doMonitor方法。</p><p>再看下jvm-echart.js：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//echart</span></span><br><span class="line"><span class="keyword">var</span> memoryEchart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">&#x27;memory_main&#x27;</span>));</span><br><span class="line"><span class="keyword">var</span> memoryData = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">//定义图表样式</span></span><br><span class="line"><span class="keyword">var</span> memoryOption = &#123;</span><br><span class="line">    <span class="attr">tooltip</span> : &#123;</span><br><span class="line">        <span class="attr">trigger</span>: <span class="string">&#x27;axis&#x27;</span>,</span><br><span class="line">        <span class="attr">axisPointer</span> : &#123;            <span class="comment">// 坐标轴指示器，坐标轴触发有效</span></span><br><span class="line">            <span class="attr">type</span> : <span class="string">&#x27;shadow&#x27;</span>        <span class="comment">// 默认为直线，可选为：&#x27;line&#x27; | &#x27;shadow&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">formatter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">params</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> dataIndex = params[<span class="number">0</span>].dataIndex;</span><br><span class="line">            <span class="keyword">var</span> res = params[<span class="number">0</span>].axisValue;</span><br><span class="line">            <span class="keyword">if</span>(dataIndex==<span class="number">0</span> || dataIndex==<span class="number">1</span>)&#123;</span><br><span class="line">                res += <span class="string">&#x27;&lt;br/&gt;累计回收次数：&#x27;</span> + params[<span class="number">0</span>].data;</span><br><span class="line">                res += <span class="string">&#x27;&lt;br/&gt;累计回收时间：&#x27;</span> + params[<span class="number">1</span>].data + <span class="string">&quot;ms&quot;</span>;</span><br><span class="line">                res += <span class="string">&#x27;&lt;br/&gt;平均回收时间：&#x27;</span> + <span class="built_in">parseInt</span>(params[<span class="number">1</span>].data/params[<span class="number">0</span>].data) + <span class="string">&quot;ms&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                res += <span class="string">&#x27;&lt;br/&gt;已用内存量：&#x27;</span> + params[<span class="number">0</span>].data + <span class="string">&quot;MB&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span>(params[<span class="number">0</span>].axisValue!=<span class="string">&#x27;峰值内存消耗&#x27;</span>)&#123;</span><br><span class="line">                    <span class="keyword">var</span> maxData = memoryData[<span class="number">2</span>];</span><br><span class="line">                    res += <span class="string">&#x27;&lt;br/&gt;可用内存量：&#x27;</span> + params[<span class="number">1</span>].data + <span class="string">&quot;MB&quot;</span>;</span><br><span class="line">                    res += <span class="string">&#x27;&lt;br/&gt;最大内存量：&#x27;</span> + maxData[dataIndex] + <span class="string">&quot;MB&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">color</span>: [<span class="string">&#x27;#ff0000&#x27;</span>,<span class="string">&#x27;#91C7AE&#x27;</span>],</span><br><span class="line">    <span class="attr">legend</span>: &#123;</span><br><span class="line">        <span class="attr">data</span>: [<span class="string">&#x27;已用内存(MB)&#x27;</span>, <span class="string">&#x27;可用内存(MB)&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">grid</span>: &#123;</span><br><span class="line">        <span class="attr">left</span>: <span class="string">&#x27;3%&#x27;</span>,</span><br><span class="line">        <span class="attr">right</span>: <span class="string">&#x27;4%&#x27;</span>,</span><br><span class="line">        <span class="attr">bottom</span>: <span class="string">&#x27;3%&#x27;</span>,</span><br><span class="line">        <span class="attr">containLabel</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">xAxis</span>:  &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;value&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">yAxis</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;category&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: [<span class="string">&#x27;OldGenGC&#x27;</span>,<span class="string">&#x27;EdenGC&#x27;</span>,<span class="string">&#x27;Old Gen&#x27;</span>,<span class="string">&#x27;Survivor Space&#x27;</span>,<span class="string">&#x27;Eden Space&#x27;</span>,<span class="string">&#x27;峰值内存消耗&#x27;</span>,<span class="string">&#x27;JVM总内存&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">series</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;已用内存(MB)&#x27;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;bar&#x27;</span>,</span><br><span class="line">            <span class="attr">stack</span>: <span class="string">&#x27;总量&#x27;</span>,</span><br><span class="line">            <span class="attr">barWidth</span>: <span class="number">60</span>,</span><br><span class="line">            <span class="attr">label</span>: &#123;</span><br><span class="line">                <span class="attr">normal</span>: &#123;</span><br><span class="line">                    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">position</span>: <span class="string">&#x27;insideRight&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">data</span>: memoryData[<span class="number">0</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;可用内存(MB)&#x27;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;bar&#x27;</span>,</span><br><span class="line">            <span class="attr">stack</span>: <span class="string">&#x27;总量&#x27;</span>,</span><br><span class="line">            <span class="attr">barWidth</span>: <span class="number">60</span>,</span><br><span class="line">            <span class="attr">label</span>: &#123;</span><br><span class="line">                <span class="attr">normal</span>: &#123;</span><br><span class="line">                    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">position</span>: <span class="string">&#x27;insideRight&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">data</span>: memoryData[<span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">memoryEchart.setOption(memoryOption);</span><br><span class="line"></span><br><span class="line"><span class="comment">//刷新图表数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">refreshMemoryData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    memoryEchart.setOption(&#123;</span><br><span class="line">        <span class="attr">series</span>: [&#123;</span><br><span class="line">            <span class="attr">data</span>: memoryData[<span class="number">0</span>]</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            <span class="attr">data</span>: memoryData[<span class="number">1</span>]</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//与websocket建立连接</span></span><br><span class="line"><span class="keyword">var</span> memorySocket;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initMemorySocket</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(memorySocket!=<span class="literal">undefined</span> || memorySocket!=<span class="literal">null</span>)&#123;</span><br><span class="line">        memorySocket.close(<span class="string">&quot;3000&quot;</span>, <span class="string">&quot;断开连接&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> wsUrl = <span class="string">&#x27;ws://&#x27;</span>+$(<span class="string">&#x27;#hid_host&#x27;</span>).val()+<span class="string">&#x27;/websocket/jvm/monitor&#x27;</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(wsUrl);</span><br><span class="line">    memorySocket = <span class="keyword">new</span> WebSocket(wsUrl);</span><br><span class="line">    memorySocket.onopen = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Connection the jvm monitor server success!!!&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    memorySocket.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> memory = $.parseJSON(evt.data);</span><br><span class="line">        <span class="keyword">var</span> peakUsed = memory.old.usedPeak + memory.eden.usedPeak;</span><br><span class="line">        <span class="keyword">var</span> usedData = [memory.oldGc.gcCount, memory.edenGc.gcCount, memory.old.used, memory.survivor.used, memory.eden.used, peakUsed, memory.totalUsedMemery];</span><br><span class="line">        <span class="keyword">var</span> peakMax = <span class="built_in">parseInt</span>((memory.old.maxPeak + memory.eden.maxPeak)*<span class="number">0.8</span>);</span><br><span class="line">        <span class="keyword">var</span> usable = [memory.oldGc.gcTime, memory.edenGc.gcTime, memory.old.max-memory.old.used,</span><br><span class="line">            memory.survivor.max-memory.survivor.used, memory.eden.max-memory.eden.used, <span class="number">0</span>, memory.totalMaxMemery-memory.totalUsedMemery];</span><br><span class="line">        <span class="keyword">var</span> maxData = [memory.oldGc.gcTime, memory.edenGc.gcTime, memory.old.max, memory.survivor.max, memory.eden.max, <span class="number">0</span>, memory.totalMaxMemery];</span><br><span class="line">        memoryData[<span class="number">0</span>] = usedData;</span><br><span class="line">        memoryData[<span class="number">1</span>] = usable;</span><br><span class="line">        memoryData[<span class="number">2</span>] = maxData;</span><br><span class="line">        refreshMemoryData();</span><br><span class="line">    &#125;;</span><br><span class="line">    memorySocket.onerror = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">        memorySocket.close();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//断开监控连接</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">closeMemoryMonitor</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(memorySocket!=<span class="literal">undefined</span> || memorySocket!=<span class="literal">null</span>)&#123;</span><br><span class="line">        memorySocket.close(<span class="string">&quot;3000&quot;</span>, <span class="string">&quot;断开连接&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    memoryData[<span class="number">0</span>] = [];</span><br><span class="line">    memoryData[<span class="number">1</span>] = [];</span><br><span class="line">    memoryData[<span class="number">2</span>] = [];</span><br><span class="line">    refreshMemoryData();</span><br><span class="line">    $.messager.show(&#123; <span class="attr">title</span>: <span class="string">&#x27;系统提示&#x27;</span>, <span class="attr">msg</span>: <span class="string">&#x27;已断开监控连接！&#x27;</span>&#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Disconnect the jvm monitor server success!!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    initMemorySocket();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这个就是在解析后台数据构造Echart图表，这儿就不详细介绍了。</p><p>详细源码可以在 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/JavaZWT/framework-base/tree/master/jvm-monitor-memory">jvm-monitor-memory</a> 看到。</p><p>我们可以简单看下运行效果图，可以看到JVM进行垃圾回收后内存的变化情况。</p><p><img data-src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/article/pasted-428.gif" alt="upload successful"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>通过这篇文章，我们了解了JVM垃圾回收的一些运行原理，对JVM堆内存有了更深入的认识。了解虚拟机内存及垃圾回收的一些特性，有助于我们在工作过程中排查定位问题。</p></div><div style="text-align:center;color:#ccc;font-size:15px"><br><br><br>-------------文章结束啦 ~\(≧▽≦)/~ 感谢您的阅读-------------</div><br><div class="reward-container"><div>您的支持就是我创作的动力！</div><button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'>打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/others/wechatpay.png" alt="SakuraTears 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/others/alipay.jpg" alt="SakuraTears 支付宝"><p>支付宝</p></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>SakuraTears</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.sakuratears.top/blog/JVM%E5%A0%86%E5%86%85%E5%AD%98%E5%8F%8A%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%80%E4%BB%8B.html" title="JVM堆内存及垃圾回收简介">https://www.sakuratears.top/blog/JVM堆内存及垃圾回收简介.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><p>欢迎关注我的其它发布渠道</p><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/others/qrcode_wechat_subscriber.jpg" rel="external nofollow noopener noreferrer"><span class="icon"><i class="fab fa-weixin"></i> </span><span class="label">WeChat</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i> </span><span class="label">RSS</span></a></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Java/" rel="tag"># Java</a> <a href="/tags/JVM/" rel="tag"># JVM</a> <a href="/tags/GC/" rel="tag"># GC</a></div><div class="post-widgets"><div class="wp_rating"><div id="wpac-rating"></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/blog/Spring-Lookup%E6%B3%A8%E8%A7%A3.html" rel="prev" title="Spring Lookup注解"><i class="fa fa-chevron-left"></i> Spring Lookup注解</a></div><div class="post-nav-item"><a href="/blog/%EF%BC%88%E8%BD%AC%EF%BC%89%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84CAP%E7%90%86%E8%AE%BA.html" rel="next" title="（转）分布式系统下的CAP理论">（转）分布式系统下的CAP理论 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AD%A3%E6%96%87"><span class="nav-number">2.</span> <span class="nav-text">正文</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-number">2.1.</span> <span class="nav-text">堆内存结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">GC流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E7%AE%97%E6%B3%95"><span class="nav-number">2.3.</span> <span class="nav-text">垃圾收集算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95"><span class="nav-number">2.4.</span> <span class="nav-text">垃圾回收算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8"><span class="nav-number">2.5.</span> <span class="nav-text">垃圾收集器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JVM%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8F%82%E6%95%B0"><span class="nav-number">2.6.</span> <span class="nav-text">JVM的一些参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM%E7%9A%84%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0"><span class="nav-number">2.6.1.</span> <span class="nav-text">JVM的基础参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%8F%82%E6%95%B0"><span class="nav-number">2.6.2.</span> <span class="nav-text">JVM垃圾回收参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM%E5%85%B6%E5%AE%83%E5%8F%82%E6%95%B0"><span class="nav-number">2.6.3.</span> <span class="nav-text">JVM其它参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%84%E4%B8%AA%E5%8C%BA%E5%9F%9F%E7%9A%84OOM"><span class="nav-number">2.7.</span> <span class="nav-text">各个区域的OOM</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JVM-%E6%97%A5%E5%BF%97"><span class="nav-number">2.8.</span> <span class="nav-text">JVM 日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JVM%E7%9B%91%E6%8E%A7Demo"><span class="nav-number">2.9.</span> <span class="nav-text">JVM监控Demo</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="SakuraTears" src="https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/others/avatar.jpg"><p class="site-author-name" itemprop="name">SakuraTears</p><div class="site-description" itemprop="description">越努力越幸运</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">142</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">106</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/JavaZWT" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;JavaZWT" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:971258230@qq.com" title="E-Mail → mailto:971258230@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="http://wpa.qq.com/msgrd?v=3&uin=971258230&site=qq&menu=yes" title="QQ → http:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;971258230&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/JavaZWT" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;JavaZWT" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-copyright fa-fw"></i>CSDN</a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://www.sakuratears.top/" title="https:&#x2F;&#x2F;www.sakuratears.top">SakuraTears的小乖乖</a></li><li class="links-of-blogroll-item"><a href="http://jm.taobao.org/" title="http:&#x2F;&#x2F;jm.taobao.org&#x2F;" rel="external nofollow noopener noreferrer" target="_blank">阿里巴巴中间件团队博客</a></li><li class="links-of-blogroll-item"><a href="https://blog.ymfe.org/" title="https:&#x2F;&#x2F;blog.ymfe.org&#x2F;" rel="external nofollow noopener noreferrer" target="_blank">去哪儿网大前端技术博客</a></li></ul></div><div class="links-of-blogroll motion-element links-of-blogroll-inline" style="opacity:1;display:block;transform:translateX(0);margin-top:8px"></div><div id="aplayer-rWUYQYrx" class="aplayer aplayer-tag-marker" style="margin:30px 0 30px 0;width:auto"></div><script>var options={narrow:!1,autoplay:!1,showlrc:0,mutex:!0,theme:"#e6d0b2",preload:"none",listmaxheight:"500px",music:[{title:"Sakura Tears",author:"Nigel Silin",url:"http://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/Nigel%20Silin%20-%20Sakura%20Tears.mp3",pic:"http://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/music1.jpeg"},{title:"东京不太热",author:"封茗囧菌",url:"http://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/%E5%B0%81%E8%8C%97%E5%9B%A7%E8%8F%8C%20-%20%E4%B8%9C%E4%BA%AC%E4%B8%8D%E5%A4%AA%E7%83%AD.mp3",pic:"http://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/music2.jpeg"},{title:"春风吹",author:"锦零",url:"http://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/%E9%94%A6%E9%9B%B6%20-%20%E6%98%A5%E9%A3%8E%E5%90%B9%EF%BC%88Cover%20%E6%96%B9%E5%A4%A7%E5%90%8C%EF%BC%89.mp3",pic:"http://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/music3.jpeg"},{title:"Secret",author:"茶太",url:"https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/%E8%8C%B6%E5%A4%AA%20-%20Secret.mp3",pic:"http://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/music4.jpeg"},{title:"secret base ~君がくれたもの~",author:"茅野愛衣,戸松遥,早見沙織",url:"https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/%E8%8C%85%E9%87%8E%E6%84%9B%E8%A1%A3%2C%E6%88%B8%E6%9D%BE%E9%81%A5%2C%E6%97%A9%E8%A6%8B%E6%B2%99%E7%B9%94%20-%20secret%20base%20%7E%E5%90%9B%E3%81%8B%E3%82%99%E3%81%8F%E3%82%8C%E3%81%9F%E3%82%82%E3%81%AE%7E%20%2810%20years%20after%20Ver.%29.mp3",pic:"http://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/music5.jpeg"},{title:"ファンファーレ",author:"sumika",url:"https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/sumika%20-%20%E3%83%95%E3%82%A1%E3%83%B3%E3%83%95%E3%82%A1%E3%83%BC%E3%83%AC.mp3",pic:"http://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/music6.jpeg"},{title:"心做し",author:"双笙",url:"https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/%E5%8F%8C%E7%AC%99%20-%20%E5%BF%83%E5%81%9A%E3%81%97%EF%BC%88Cover%20GUMI%EF%BC%89.mp3",pic:"https://sakuratears.oss-cn-beijing.aliyuncs.com/blog/music/music7.jpeg"}]};options.element=document.getElementById("aplayer-rWUYQYrx");var ap=new APlayer(options);window.aplayers||(window.aplayers=[]),window.aplayers.push(ap)</script></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">SakuraTears</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">1.5m</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">22:58</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">NexT.Pisces</a> 强力驱动</div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><script>(function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"n81D2zVCOBCRyTrhhwoBjui0-gzGzoHsz","app_key":"2II35ez36s8c4KvXJNGVeJ5O","server_url":null,"security":true};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();</script></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script>!function(){var e,t,o,n,r,a=document.getElementsByTagName("link");if(0<a.length)for(i=0;i<a.length;i++)"canonical"==a[i].rel.toLowerCase()&&a[i].href&&(e=a[i].href);t=e?e.split(":")[0]:window.location.protocol.split(":")[0],e=e||window.location.href,window,n=e,r=document.referrer,/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(n)||(o="https"===String(t).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif",r?(o+="?r="+encodeURIComponent(document.referrer),n&&(o+="&l="+n)):n&&(o+="?l="+n),(new Image).src=o)}()</script><script>CONFIG.page.isPost&&(wpac_init=window.wpac_init||[],wpac_init.push({widget:"Rating",id:12042,el:"wpac-rating",color:"fc6423"}),function(){var e,t;"WIDGETPACK_LOADED"in window||(WIDGETPACK_LOADED=!0,(e=document.createElement("script")).type="text/javascript",e.async=!0,e.src="//embed.widgetpack.com/widget.js",(t=document.getElementsByTagName("script")[0]).parentNode.insertBefore(e,t.nextSibling))}())</script><script src="/js/local-search.js"></script><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div><script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script><script>flOptions={iconStyle:"default",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'n81D2zVCOBCRyTrhhwoBjui0-gzGzoHsz',
      appKey     : '2II35ez36s8c4KvXJNGVeJ5O',
      placeholder: "(*^_^*)看了这么多，可能你有话想说",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script><script>!function(){var c=0;jQuery(document).ready(function(a){a("html").click(function(t){var e,b=18;10==++c?e=a("<b></b>").text("OωO"):20==c?e=a("<b></b>").text("(๑•́ ∀ •̀๑)"):30==c?e=a("<b></b>").text("(๑•́ ₃ •̀๑)"):40==c?e=a("<b></b>").text("(๑•̀_•́๑)"):50==c?e=a("<b></b>").text("（￣へ￣）"):60==c?e=a("<b></b>").text("(╯°口°)╯(┴—┴"):70==c?e=a("<b></b>").text("૮( ᵒ̌皿ᵒ̌ )ა"):80==c?e=a("<b></b>").text("╮(｡>口<｡)╭"):90==c?e=a("<b></b>").text("( ง ᵒ̌皿ᵒ̌)ง⁼³₌₃"):100<=c&&c<=105?e=a("<b></b>").text("(ꐦ°᷄д°᷅)"):(e=a("<b></b>").text("(*^__^*)"),b=Math.round(14*Math.random()+6));var n=t.pageX,o=t.pageY;e.css({"z-index":9999,top:o-20,left:n,position:"absolute",color:"#199475","font-size":b,"-moz-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none"}),a("body").append(e),e.animate({top:o-180,opacity:0},1500,function(){e.remove()})})})}()</script><script>document.onkeydown=function(){var e,t,n;window.event&&(123==(e=window.event).keyCode&&(console.log("禁用F12键"),e.keyCode=0,e.returnValue=!1),t=e.ctrlKey||e.metaKey,n=e.shiftKey,t&&n&&73==e.keyCode&&(console.log("禁用Ctrl+Shift+I键"),e.keyCode=0,e.returnValue=!1))},document.oncontextmenu=function(e){window.event&&(e=window.event);try{var t=e.srcElement;return"INPUT"==t.tagName&&"text"==t.type.toLowerCase()||"TEXTAREA"==t.tagName?!0:!1}catch(e){return!1}},document.onpaste=function(e){window.event&&(e=window.event);try{var t=e.srcElement;return"INPUT"==t.tagName&&"text"==t.type.toLowerCase()||"TEXTAREA"==t.tagName?!0:!1}catch(e){return!1}},document.oncopy=function(e){window.event&&(e=window.event);try{var t=e.srcElement;return"INPUT"==t.tagName&&"text"==t.type.toLowerCase()||"TEXTAREA"==t.tagName?!0:!1}catch(e){return!1}},document.oncut=function(e){window.event&&(e=window.event);try{var t=e.srcElement;return"INPUT"==t.tagName&&"text"==t.type.toLowerCase()||"TEXTAREA"==t.tagName?!0:!1}catch(e){return!1}},document.onselectstart=function(e){window.event&&(e=window.event);try{var t=e.srcElement;return"INPUT"==t.tagName&&"text"==t.type.toLowerCase()||"TEXTAREA"==t.tagName?!0:!1}catch(e){return!1}};var fuck=document.createElement("div");Object.defineProperty(fuck,"id",{get:function(){console.log("Hello World!"),location.href="about:blank",history.replaceState()}}),console.log(fuck)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({model:{scale:1,hHeadPos:.5,vHeadPos:.618},display:{superSample:2,width:250,height:500,position:"right",hOffset:0,vOffset:-20},mobile:{show:!1,scale:.1,motion:!0},react:{opacityDefault:.9,opacityOnHover:.3},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html>